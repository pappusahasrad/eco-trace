<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrace - AI Food Waste Tracker</title>
    <style>
        :root {
            --primary: #2e7d32;
            --bg: #f8f9fa;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; }
        .input-section { margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: none; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; transition: opacity 0.2s; }
        .btn-predict { background: #1565c0; }
        .btn-impact { background: #2e7d32; }
        button:hover { opacity: 0.9; }
        #ai-response { margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; min-height: 50px; white-space: pre-wrap; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <h1>EcoTrace AI</h1>
    <p>Enter your inventory or food waste data below to get AI-powered insights.</p>

    <div class="input-section">
        <textarea id="userInput" placeholder="Example: 50 lbs of tomatoes expiring Friday, 20 gallons of milk wasted last week..."></textarea>
        <div class="btn-group">
            <button class="btn-predict" onclick="handleAction('predict')">Predictive Ordering</button>
            <button class="btn-impact" onclick="handleAction('impact')">Waste Impact Report</button>
        </div>
    </div>

    <div id="ai-response">Your AI insights will appear here...</div>
</div>

<script>
    async function handleAction(type) {
        const input = document.getElementById('userInput').value;
        const display = document.getElementById('ai-response');

        if (!input.trim()) {
            alert("Please enter some data first!");
            return;
        }

        let prompt = "";
        if (type === 'predict') {
            prompt = `Based on this food data: "${input}", provide a smart ordering plan to reduce future waste. Use bullet points.`;
        } else {
            prompt = `Analyze the environmental impact (CO2, water, money) for this waste: "${input}". Be concise.`;
        }

        // Call our internal Vercel API
        await callGemini(prompt);
    }

    async function callGemini(prompt) {
        const display = document.getElementById('ai-response');
        display.innerText = "EcoTrace AI is calculating...";

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();

            // SAFETY CHECK: Prevents the "Cannot read properties of undefined" error
            if (data && data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                const text = data.candidates[0].content.parts[0].text;
                display.innerText = text;
            } else {
                console.error("AI Error:", data);
                display.innerText = "AI Error: Received an empty or blocked response. Check your Vercel logs and API key.";
            }

        } catch (error) {
            console.error("Connection Error:", error);
            display.innerText = "Error: Could not connect to the server. Make sure you are running on Vercel or a local server.";
        }
    }
</script>

</body>
</html>
